#! @BASH@
failed_nb=0
success_nb=0
tests_nb=0
if [ xvalgrind = "x$1" ] ; then
  valgrind=valgrind
else
  valgrind=
fi
for test in log_usage                           \
            dynar_int dynar_double dynar_string \
 	    dict_usage dict_crash               \
	    config_usage                        \
	    \
	    datadesc_usage
do		    
  tests_nb=`expr $tests_nb + 1`
  echo "#### Test $test"
  if [ "x$test" = "xdict_crash" ] ; then
    ./$test --gras-log="root.thres=info" 2>&1
  else 
    $valgrind ./$test --gras-log="root.thres=info" 2>&1
  fi
  if [ $? != 0 ] ; then
    echo "## failed. Rerun $test with full details."
    if [ "x$test" = "xdict_crash" ] ; then
      ./$test --gras-log="root.thres=debug" 2>&1
    else 
      $valgrind ./$test --gras-log="root.thres=debug" 2>&1
    fi
    failed_nb=`expr $failed_nb + 1`
    failed="$failed $test"
  else
    echo "## Success"
    success_nb=`expr $success_nb + 1`
    success="$success $test"
  fi
done
failed=`echo $failed|sed 's|^ ||'`
success=`echo $success|sed 's|^ ||'`
echo
echo "#### Summary"
echo "$success_nb tests of $tests_nb successfull ($success)"
if [ $failed_nb != 0 ] ; then
  echo "$failed_nb tests of $tests_nb failed ($failed)"
  echo "Rerun the tests using the following command: script -c 'make test' gras.tests.log"
  echo " and send the following informations to martin.quinson@ens-lyon.fr:"
  echo "   - the file gras.tests.log produced by this command"
  echo "   - a short description of the target platform (arch, OS, distrib, compiler)."
  echo "   - the config.log produced by the compilation, if possible."
fi
exit $failed_nb
