#! @BASH@
failed_nb=0
success_nb=0
ignored_nb=0
tests_nb=0

rm -f test.failed test.success test.ignored

if [ xvalgrind = "x$1" ] ; then
  valgrind="libtool --mode=execute valgrind"
else
  valgrind=
fi
for test in xbt/log_usage                                          \
            xbt/dynar_int xbt/dynar_double xbt/dynar_string      \
 	    xbt/dict_usage xbt/dict_crash                         \
	    xbt/config_usage                                       \
	    \
	    gras/trp_tcp_usage      gras/trp_file_usage             \
	    gras/datadesc_usage                                     
#	    "gras/datadesc_usage --read @srcdir@/datadesc.little32" \
#	    "gras/datadesc_usage --read @srcdir@/datadesc.big32"    \
#	    "gras/datadesc_usage --read @srcdir@/datadesc.big64" 

#	    "gras/datadesc_usage --read @srcdir@/datadesc.little64" \
do		    
  tests_nb=`expr $tests_nb + 1`
  echo "#### Test $test"
  if [ "x$test" = "xdict_crash" ] ; then
    ./$test --gras-log="root.thres=info" 2>&1
  else 
    $valgrind ./$test --gras-log="root.thres=info" 2>&1
  fi
  retval=$?
  if [ $retval != 0 ] ; then if [ $retval != 77 ]; then
    echo "## failed. Rerun $test with full details."
    if [ "x$test" = "xdict_crash" ] ; then
      ./$test --gras-log="root.thres=debug" 2>&1
    else 
      $valgrind ./$test --gras-log="root.thres=debug" 2>&1
    fi
    failed_nb=`expr $failed_nb + 1`
    echo "  $test (returned $retval)" >> test.failed
  else # retval == 77
    echo "## Ignored since it returned 77"
    ignored_nb=`expr $ignored_nb + 1`
    echo "  $test" >> test.ignored
  fi else
    echo "## Success"
    success_nb=`expr $success_nb + 1`
    echo "  $test" >> test.success
  fi
done


echo
echo "#### Summary"
echo "$success_nb tests of $tests_nb successfull:"
cat test.success

if [ $ignored_nb != 0 ] ; then
  echo "$failed_nb tests of $tests_nb ignored:"
  cat test.ignored
  echo "  (they returned 77, meaning that they are not applicable)"
fi
if [ $failed_nb != 0 ] ; then
  echo "$failed_nb tests of $tests_nb failed: "
  cat test.failed
  echo "Rerun the tests using the following command: script -c 'make test' gras.tests.log"
  echo " and send the following informations to martin.quinson@ens-lyon.fr:"
  echo "   - the file gras.tests.log produced by this command."
  echo "   - a short description of the target platform (arch, OS, distrib, compiler)."
  echo "   - the config.log produced by the compilation."
fi

rm -f test.success test.failed test.ignored
exit $failed_nb
